# PHASE 2.1: Virtual File System (VFS)

**Phase Context**: Phase 2 implements core system utilities. This sub-phase creates a unified file system abstraction supporting multiple storage backends.

**Sub-Phase Objective**: Implement VFS interface with MemFS, DiskFS, and OverlayFS backends, file locking, permission system, and path resolution.

**Prerequisites**: 
- Phase 1 complete

**Integration Point**: VFS will be used by shell, file operations, and all file-based services.

---

## IMPLEMENTATION REQUIREMENTS

### Overview

You are implementing a virtual file system with multiple storage backends, inspired by OpenBSD's FFS (Fast File System).

---

### Directory Structure

```
webos/
├── pkg/
│   └── vfs/
│       ├── doc.go              # Package documentation
│       ├── interface.go        # VFS interface
│       ├── file.go             # File implementation
│       ├── path.go             # Path resolution
│       ├── memfs/              # In-memory filesystem
│       │   ├── memfs.go
│       │   └── memfs_test.go
│       ├── diskfs/             # Disk-based filesystem
│       │   ├── diskfs.go
│       │   └── diskfs_test.go
│       └── overlayfs/          # Layered filesystem
│           ├── overlayfs.go
│           └── overlayfs_test.go
└── cmd/
    └── vfs-demo/
        └── main.go             # Demonstration program
```

---

### Core Types

```go
package vfs

// FileSystem is the VFS interface
type FileSystem interface {
    Open(path string, flags int) (File, error)
    Stat(path string) (FileInfo, error)
    Mkdir(path string, perm os.FileMode) error
    Remove(path string) error
    Rename(oldpath, newpath string) error
    ReadDir(path string) ([]DirEntry, error)
    OpenFile(path string, flags int, perm os.FileMode) (File, error)
}

// File represents an open file
type File interface {
    Read(b []byte) (int, error)
    Write(b []byte) (int, error)
    Seek(offset int64, whence int) (int64, error)
    Close() error
    Stat() (FileInfo, error)
    io.Reader
    io.Writer
    io.Seeker
}

// FileInfo contains file metadata
type FileInfo struct {
    Name    string
    Size    int64
    Mode    os.FileMode
    ModTime time.Time
    IsDir   bool
}
```

---

### Implementation Steps

1. **VFS Interface**: Define core VFS operations
2. **MemFS**: In-memory filesystem for ephemeral storage
3. **DiskFS**: Persistent filesystem with custom format
4. **OverlayFS**: Layered filesystem for copy-on-write
5. **Path Resolution**: Symlink handling, absolute/relative paths
6. **File Locking**: Advisory and mandatory locking

---

### Testing Requirements

- All storage backends functional
- Path resolution correctness
- File locking prevents race conditions
- Permission enforcement
- Crash recovery (journaling)

---

### Next Sub-Phase

**PHASE 2.2**: Process Management System

---

## Deliverables

- `pkg/vfs/` - Complete VFS implementation
- Three storage backend implementations
- File locking mechanism
- Permission system
- Comprehensive test suite
